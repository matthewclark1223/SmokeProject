---
title: Estimating the Financial Impact of Wildfire Smoke on US National parks
author:
- affiliation: Boise State University - Human Environment Systems
  name: Matt Clark
- affiliation: University of Michigan
  name: Alexander Killion
- affiliation: Boise State University
  name: Matthew A. Williamson
- affiliation: Boise State University
  name: Vicken?
- affiliation: Boise State University
  name: Laura? (undergrad who will continue working over summer)
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    keep_tex: yes
    latex_engine: pdflatex
    template: /Users/Matthewclark989/Documents/LatexPractice/templatedocs/svm_ms_template.tex
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
keywords: pandoc, r markdown, knitr
bibliography: /Users/Matthewclark989/Documents/SmokeProject/References.bib
thanks: If we want to thank anyone? Maybe Moji?.
abstract: National Parks are important. National Parks are low on funding which affects their ability to do their job. A key way they get this funding is through visitation. Wildfire smoke affects visitation greatly and is out of ther control. Wildfires are expected to increase in the Pacific West and Intermountain regions. Over the last 38 years, we estimate that wildfire smoke has led to a 12% overall visitation decrease to National Parks in these regions. When accounting for visitation fees, this loss may have cost the National Park Service as much as $580 million in total. Wildfires and the smoke it produces is supposed to increase over the next 50 years. Assuming a linear trend in smoke, visitation overall, and park fees, we might see a financial loss to the park service of $XX. Our recomendation is that....NPS work with the forest service to prevent fires in areas close to parks?? Do they already do that??    
---
# 1. Introduction 
Public lands are a cornerstone of American culture and identity. The crown jewels of the American public lands system are the National Parks. National Parks have recently drawn public attention for having a lack of funding which negatively affects their ability to protect America's most cherished natural resources and provide visitors with desired recreational experiences. While the National Park Service makes countless decisions regarding where to allocate resources and how to best invest its limited funding, other monetary sources and sinks are out of the control of the National Park Service.
This is how you add a reference (e.g., [@fisichelli_protected_2015; @fann_ch_2016])
  

# 2. Methods
```{r include=FALSE, cache=TRUE}
library(tidyverse)
library(lme4)
library(rstanarm)
library(rstan)
library(zoo)
library(formattable)
load("~/SmokeProject/ModelObjects/feefit.rda")
load("~/SmokeProject/ModelObjects/residuals.rda")
load("~/SmokeProject/ModelObjects/CVResidualMod.rds")
```
## 2.1. Data Collection

### 2.1.1. Visitor Data

### 2.1.2. Visitation Fees

We started with an incomplete dataset. Laura will write this part with information on collecting this data. 
```{r include=FALSE, cache=TRUE}
FEdat<-read.csv("~/SmokeProject/Data/LauraStoddardEntryFeeCsv.csv")
FEdat<-FEdat %>% dplyr::select(Park,Year,SingleVisitorEntryFee) #keep only these columns
```


We removed the NA's from this dataset built a linear model which estimates the fees based on the date and the park. 
```{r, echo=FALSE, cache=TRUE}
d<-na.omit(FEdat) #get rid of rows with any NA
```

$$
\begin{aligned}
y_{tp} &\sim \begin{cases}\operatorname{Pois}(\mu,\lambda)\\ \mu = B_{0}+ B_{1}*X_{1} +B_{2}*X_{2}
\end{cases}
\end{aligned}
$$

We operationalized this model in rstanarm


We then used this to predict what the fees would have been for every year we didn't have
```{r cache=TRUE, include=FALSE}
fillData<-FEdat[,1:2]


FEdat$PredictedFee<-apply(posterior_predict(feefit,fillData),2,mean) #assuming this is for a new column

```

Our predicted fees correlate well with our observed fees that we have
```{r echo = FALSE, cache=TRUE}
xx<-na.omit(FEdat)
 mytheme<- theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                  plot.title = element_text( size=18, color="black",face="bold"),
                  axis.title.x = element_text( size=18),
                  axis.title.y = element_text( size=18),
                  axis.text=(element_text(color="black", size=14)),
                  legend.title = element_text(colour="black", size=18),
                  legend.text = element_text( size = 14))
xx%>%
  ggplot(.,aes(x=SingleVisitorEntryFee,y=PredictedFee))+
  geom_jitter(size=2, alpha=0.3)+
  geom_smooth(method="lm", se=FALSE, colour="red")+
  geom_text(aes(x=5,y=15),size=10,label=paste("cor =",round(cor(xx$PredictedFee,xx$SingleVisitorEntryFee),digits=2)))+
  ggtitle("Predicted vs Observed Single Visitor Entry Fee")+theme_classic()+mytheme+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(name="Predicted Single Visitor Entry Fee",labels = scales::dollar_format(prefix = "$"))+
  scale_x_continuous(name="Observed Single Visitor Entry Fee",labels = scales::dollar_format(prefix = "$"))
```

### 2.1.3. Smoke Data

Alex to complete this section

## 2.2. Analysis

### 2.2.1. Smoke Effects Past
We subset the data to only include high season visitation for parks in the Inter-mountain and Pacific West regions. The regions projected to be most heavily affected by climate change. 

```{r include=FALSE, cache=TRUE}
library(tidyverse)
library(lme4)
library(rstan)
Data<-read_csv("~/SmokeProject/Data/MergedDataComplete.csv")[,-1]
Data$date<-zoo::as.yearmon(paste0(Data$Month,Data$Year),"%m%Y")
Data<-Data%>%group_by(UnitCode,Month)%>%mutate(ARVis = lag(RecreationVisits) )
Data$VisChange<-(Data$RecreationVisits-Data$ARVis)/Data$ARVis
Data<-na.omit(Data)

#filter by high season
Data<-Data%>%filter( SeasType =="High")

#filter by smoke affected regions
Data<-Data%>%
  filter(Region %in% c("Intermountain","Pacific West"))

```



To account for the linear trends of visitation, we first calculated the trends, then found the residuals of each datapoint from the trendline.
$$
\begin{aligned}
Resid_{y} &= \begin{cases}y_{obs}-y_{trend}\\ y_{trend} \sim \operatorname{Norm}(\mu_{park},\sigma)\\ \mu_{park} = B_{0}+ B_{1}*X_{1}
\end{cases}
\end{aligned}
$$



```{r warning=FALSE, include=FALSE, cache=TRUE}
fits <- lmList(RecreationVisits ~ date | UnitCode, data=Data) 
Data$trendvis<-predict(fits,date=Data$date)
Data$VisDiff<-Data$RecreationVisits-Data$trendvis
dat<-Data
```


We then used a hierarchical modeling structure to understand these residuals as a result of the max observed smoke values in each park in each month.
$$
\begin{aligned}
Resid_{y} &\sim \begin{cases}\operatorname{Norm}(\mu,\sigma)\\ \mu = B_{0Park}+ B_{1Park}*X_{1Park} \\ \sigma\sim Norm(0,1) 
\end{cases}
\end{aligned}
$$

This was also operationalized in `rstanarm`
```{r eval=FALSE, cache=TRUE,include=FALSE}
fit<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=dat,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)

```

### 2.2.2. Model Validation

### 2.2.3. Smoke, Fee, & Visitation Projections


# 3. Results

## 3.1. Parameter Estimates
For all significant effects (90% C.I. doesn't overlap 0), we see a negative effect of smoke on the residual visitation to National Parks.

```{r echo=FALSE, cache=TRUE}
 plot(fit, regex_pars = "stdsmoke UnitCode",
            prob = 0.5, prob_outer = 0.9)
```

## 3.2. Backcasting
We can then go back and apply these estimates effects to the observed visitation given a minimum level of smoke observed for each park to estimate what the visitation may have been given optimal air quality. 

Here's an example from a few parks


```{r include=FALSE, cache=TRUE}


dat<-read.csv("~/SmokeProject/Data/FullDataWithMinSmokePredictions.csv")
dat$date<-zoo::as.yearmon(dat$date)
```

```{r echo=FALSE, warning=FALSE, cache=TRUE,message=FALSE}
library(scales)
dat%>%filter(UnitCode =="ROMO")%>%
ggplot(.,aes(x=date))+
  geom_ribbon(aes(ymin=PredNoSmoke5CI, ymax=PredNoSmoke95CI),fill="#1f78b4",alpha=0.2)+
  geom_ribbon(aes(ymin=PredNoSmoke25CI, ymax=PredNoSmoke75CI),fill="#1f78b4",alpha=0.5)+
  geom_line(aes(y=RecreationVisits,color="black"),size=1.25)+
  geom_line(aes(y=PredNoSmoke50CI,color="#1f78b4"),linetype="longdash",size=1.25)+theme_classic()+
  mytheme + scale_y_continuous(name="Recreational Visits", labels = scales::comma)+xlab("Date")+
  scale_color_identity(name = "",
                       breaks = c("black", "#1f78b4"),
                       labels = c("Observed", "Median Estimate"),
                       guide = "legend")+ggtitle("Rocky Mountain National Park")

dat%>%filter(UnitCode == "YOSE")%>%
ggplot(.,aes(x=date))+
  geom_ribbon(aes(ymin=PredNoSmoke5CI, ymax=PredNoSmoke95CI),fill="#1f78b4",alpha=0.2)+
  geom_ribbon(aes(ymin=PredNoSmoke25CI, ymax=PredNoSmoke75CI),fill="#1f78b4",alpha=0.5)+
  geom_line(aes(y=RecreationVisits,color="black"),size=1.25)+
  geom_line(aes(y=PredNoSmoke50CI,color="#1f78b4"),linetype="longdash",size=1.25)+theme_classic()+
  mytheme + scale_y_continuous(name="Recreational Visits", labels = scales::comma)+xlab("Date")+
  scale_color_identity(name = "",
                       breaks = c("black", "#1f78b4"),
                       labels = c("Observed", "Median Estimate"),
                       guide = "legend")+ggtitle("Yosemite National Park")

dat%>%filter(UnitCode == "ZION")%>%
ggplot(.,aes(x=date))+
  geom_ribbon(aes(ymin=PredNoSmoke5CI, ymax=PredNoSmoke95CI),fill="#1f78b4",alpha=0.2)+
  geom_ribbon(aes(ymin=PredNoSmoke25CI, ymax=PredNoSmoke75CI),fill="#1f78b4",alpha=0.5)+
  geom_line(aes(y=RecreationVisits,color="black"),size=1.25)+
  geom_line(aes(y=PredNoSmoke50CI,color="#1f78b4"),linetype="longdash",size=1.25)+theme_classic()+
  mytheme + scale_y_continuous(name="Recreational Visits", labels = scales::comma)+xlab("Date")+
  scale_color_identity(name = "",
                       breaks = c("black", "#1f78b4"),
                       labels = c("Observed", "Median Estimate"),
                       guide = "legend")+ggtitle("Zion National Park *not significant")

```


We can apply these visitation estimates to the fee data/predictions also. This gives us the following table.
```{r echo=FALSE, cache=TRUE}
fitint<-as.data.frame(posterior_interval(fit))
names(fitint)<-c("CI5","CI95")
fitint$Par<-row.names(fitint)
fitsig<-fitint[grep("stdsmoke UnitCode",row.names(fitint)),]%>% 
  filter(CI5<0 & CI95<0) 

fitsig$Par<-substr(fitsig$Par,21,24)

#predicted vis fees 
FEdat<-read.csv("~/SmokeProject/Data/ParkFees.csv")

#get the visitation observed and predicted yearly totals (same scale as fee data)
VEstDat<-dat%>%group_by(UnitCode,Year)%>%
  summarise(RecVisits=sum(RecreationVisits),PredVisits = sum(PredNoSmoke50CI))%>%
  filter(UnitCode %in% fitsig$Par)

#only include significant parks and years we predicted for
FEdat<-FEdat%>%filter(UnitCode%in%fitsig$Par)

#merge the fee and visitation data
financialData<-merge(FEdat, VEstDat, by = c("UnitCode","Year"))

#multiply the fees and visitation (predicted and observed)
financialData<-financialData%>%mutate(incomeObserved= round(SingleVisitorFee*RecVisits,digits = 2),incomePred= round(SingleVisitorFee*PredVisits,digits=2))

#get the dollar estimates for smoke loss for each park)
summaryFinancialLoss<-financialData %>% group_by(UnitCode)%>%summarise(totrec=sum(incomeObserved),totpred=sum(incomePred))%>%
  mutate(IncomeDif=totrec-totpred,IncomePrecDiff=round((1-(totrec/totpred))*100,digits=2))


summaryFinancialLoss$ParkName<-unique(dat[dat$UnitCode %in% summaryFinancialLoss$UnitCode,]$ParkName)

summaryFinancialLoss<-summaryFinancialLoss[,c(6,4,5)]
summaryFinancialLoss$IncomeDif<-currency(summaryFinancialLoss$IncomeDif)
names(summaryFinancialLoss)<-(c("National Park","Income Loss Estimate (1980-2018)", "Percent Income Loss (1980-2018)"))
summaryFinancialLoss$`Percent Income Loss (1980-2018)`<-paste0(summaryFinancialLoss$`Percent Income Loss (1980-2018)`,'%')
formattable::formattable(summaryFinancialLoss)
```
## 3.3. Model Validation
To assess the validity of our model, we used a k-fold cross validation technique.   


## 3.4. Future Projections

# 4. Discussion

Discussion here












