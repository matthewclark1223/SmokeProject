---
title: Estimating the Financial Impact of Wildfire Smoke on US National parks
author:
- affiliation: Boise State University - Human Environment Systems
  name: Matt Clark
- affiliation: University of Michigan
  name: Alexander Killion
- affiliation: Boise State University
  name: Matthew A. Williamson
- affiliation: Boise State University
  name: Vicken?
- affiliation: Boise State University
  name: Laura? (undergrad who will continue working over summer)
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    df_print: paged
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    keep_tex: yes
    latex_engine: pdflatex
  word_document: default
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
keywords: Wildfire, Smoke, Recreation, Park Science
bibliography: ../References.bib
thanks: If we want to thank anyone? Maybe Moji?.
abstract: The United States national park system serves as a global model for how natural resource protection can provide numerous social and ecological services while generating economic returns on investment. In recent years parks have increasingly relied on visitation fees to fund consevation projects as well as basic infrastructure. In contrast with congressional funding, visitation is subject to fluctuation given climatic and environmental variability. While many environmental variables are relatively predictable and stable over time, wildfire smoke events have increased drmatically via climate change, particurlarly in the American West. In this project, we assess how recreational visitation to national parks has systematically varied with wildfire smoke. Over the last 38 years, we estimate that wildfire smoke has led to a 12% overall visitation decrease to National Parks in the Pacific West and Inter-Mountain Regions. When accounting for visitation fees, this loss may have cost the National Park Service as much as $580 million in total. Wildfire frequency and severity are expected to increase considerably in these regions over the next 50 years. Assuming current trends in smoke, park visitation, and park fees continue, we expect to see significant financial losses to the National Park Service via wildfire smoke in the coming years.     
---
# 1. Introduction 

Twenty eight percent of the land area of the United States is designated as public land [@vincent_federal_2020]. These public lands are the critical backdrop for the majority wildlife conservation and outdoor recreation in the country [@romagosa_inside_2015; @leemans_millennium_2003; @dudley_national_2011]. In a 2016 study, 93% of respondents indicated that they believe public open spaces and recreational areas should be protected, regardless of whether or not they visited them personally [@haefele_total_2016]. The crown jewel of the United States public lands system is the National Park Service. The national park system alone received approximately 318 million recreational visitors and generated over $40 billion in economic output to local economies in 2018 [@thomas_2018_2018].  


National parks undeniably represent a critical infrastructure for supporting ecological integrity and outdoor recreation in the United States, but have recently drawn public attention for considerable under funding [@simmonds_crisis_2018;@duncan_opinion_2016]. Most notably for the $12 billion repair backlog for basic maintenance and resource protection [@nps_nps_2018]. In addition to necessary repairs, the National Park Service reports a 14% reduction in staff funding over the last 5 years [@doi_fiscal_2019]. While the majority of National Park Service funding comes from congressional appropriations, recent budgetary restrictions have put pressure on parks to gather an increasing amount of their budget from recreational visitor fees such as admissions and camping. The income from these fees has steadily increased over the last 10 years as park visitation and visitor fees have both surged [@gao_national_2016].  

As national parks become increasingly dependent on visitor fees in order to provide the suite of social and ecological services communities depend on, it is of paralleled importance to understand what drives fluctuation in recreational visits. Research has shown that economic considerations (e.g. park fees) are considerably less influential on park visitation than are recreational opportunities [@neuvonen_visits_2010;@stevens_declining_2014]. Most factors which influence the recreational accessibility of a given park are either fixed (e.g. natural resources within the park area) or within the control of park management (permitting, trail building, etc.). Wildfires however, largely result from external forces and have been shown to negatively affect individual's willingness to engage in recreational travel [@thapa_wildfires_2013]. Furthermore, a study of five national parks in Utah showed visitation losses from wildfire events even at a distance of up to 320 kilometers from the park boundary [@kim_wildfire_2019]. Given the distance with which wildfires have been shown to impact park visitation, it can be assumed that individuals modify their recreational behavior not only as a result of wildfires themselves but also the smoke they produce. 

Wildfire smoke is a mixture of many gasses aerated by biomass combustion across a landscape [@naeher_woodsmoke_2007]. While many of these compounds have been shown to cause health problems in humans, organic carbon and black carbon particulate matter less than 2.5 Î¼m in diameter (PM2.5) is particularly harmful to human health, causing between 260,000 - 600,000 global deaths annually [@johnston_fay_h_estimated_2012; @naeher_woodsmoke_2007]. A 2012 study estimated that wildfire smoke in Los Angeles County resulted in public health costs of approximately $84 per exposed person each day [@richardson_hidden_2012]. Health concerns regarding wildfire smoke, specifically PM2.5, regularly drive calls for individuals to reduce outdoor recreational behavior [@oneill_summary_2013]. 

Recent literature reviews on recreational behavior have found a dearth of research both describing how individual's are affected by and respond to low air quality, as well as research which gives predictions for how climate change will affect the recreation landscape in specific areas [@otoole_climate_2019;@zajchowski_air_2019-1]. Additionally, a survey of federal land managers indicated that decision makers in areas such as national parks feel that they have a shortage of information describing how air quality affects the recreational behavior of their visitors [@zajchowski_air_2019]. It is of particular importance to understand how individuals respond to wildfire smoke because of the highly variable nature of wildfires, their relationship to climate change, and the great distances that smoke can travel during and after wildfire events [@dombeck_wildfire_2004; @collins_regional_2006]. 

Wildfires and the smoke they produce have been increasing in the United States over the last 50 years, specifically in the American West and Inter-Mountain regions [@kitzberger_contingent_2007;@westerling_increasing_2016]. These regions are also projected to experience increased wildfire frequency and severity over the next 50 years as a result of climate change [@harvey_human-caused_2016; @peterson_new_2003; @barbero_climate_2015].

The primary goal of this project is to assess how visitation to national parks in the Inter-Mountain and Pacific West regions has systematically varied with surface level concentrations of PM2.5 resulting from wildfire smoke from 1980 - 2018. Given the variability in recreational fees between parks and over time, the secondary goal of this project is to produce order of magnitude estimates of the financial losses that wildfire smoke has caused park units during the same period. The intention of this research is not to perform an in-depth economic analysis of smoke effects on each park specifically, but rather to provide an approximation of how wildfire smoke affects population level recreational decision making and what the downstream economic impacts have been historically and what the implications are for the future. Overall, this research aims to better equip protected area managers with the information necessary to best manage recreational resources in the face of increasing wildfire events and climatic variability generally.     

  

# 2. Methods
```{r include=FALSE, cache=TRUE}
library(tidyverse)
library(lme4)
library(rstanarm)
library(rstan)
library(zoo)
library(formattable)
load("~/SmokeProject/ModelObjects/feefit.rda")
load("~/SmokeProject/ModelObjects/residuals.rda")
load("~/SmokeProject/ModelObjects/CVResidualMod.rds")
```

```{r, include=FALSE}
options(tinytex.verbose = TRUE)
```
## 2.1. Data Collection

### 2.1.1. Visitor Data

### 2.1.2. Visitation Fees

We started with an incomplete dataset. Laura will write this part with information on collecting this data. 
```{r include=FALSE, cache=TRUE}
FEdat<-read.csv("~/SmokeProject/Data/LauraStoddardEntryFeeCsv.csv")
FEdat<-FEdat %>% dplyr::select(Park,Year,SingleVisitorEntryFee) #keep only these columns
```


We removed the NA's from this dataset built a linear model which estimates the fees based on the date and the park. 
```{r, echo=FALSE, cache=TRUE}
d<-na.omit(FEdat) #get rid of rows with any NA
```

$$
\begin{aligned}
y_{tp} &\sim \begin{cases}\operatorname{Pois}(\mu,\lambda)\\ \mu = B_{0}+ B_{1}*X_{1} +B_{2}*X_{2}
\end{cases}
\end{aligned}
$$

We operationalized this model in rstanarm



### 2.1.3. Smoke Data

Will start this weekend. 

## 2.2. Analysis

### 2.2.1. Smoke Effects Past
We subset the data to only include high season visitation for parks in the Inter-mountain and Pacific West regions. The regions projected to be most heavily affected by climate change. 

```{r include=FALSE, cache=TRUE}
library(tidyverse)
library(lme4)
library(rstan)
Data<-read_csv("~/SmokeProject/Data/MergedDataComplete.csv")[,-1]
Data$date<-zoo::as.yearmon(paste0(Data$Month,Data$Year),"%m%Y")
Data<-Data%>%group_by(UnitCode,Month)%>%mutate(ARVis = lag(RecreationVisits) )
Data$VisChange<-(Data$RecreationVisits-Data$ARVis)/Data$ARVis
Data<-na.omit(Data)

#filter by high season
Data<-Data%>%filter( SeasType =="High")

#filter by smoke affected regions
Data<-Data%>%
  filter(Region %in% c("Intermountain","Pacific West"))

```


To account for the linear trends of visitation, we first calculated the trends, then found the residuals of each datapoint from the trend line.
$$
\begin{aligned}
Resid_{y} &= \begin{cases}y_{obs}-y_{trend}\\ y_{trend} \sim \operatorname{Norm}(\mu_{park},\sigma)\\ \mu_{park} = B_{0}+ B_{1}*X_{1}
\end{cases}
\end{aligned}
$$



```{r warning=FALSE, include=FALSE, cache=TRUE}
fits <- lmList(RecreationVisits ~ date | UnitCode, data=Data) 
Data$trendvis<-predict(fits,date=Data$date)
Data$VisDiff<-Data$RecreationVisits-Data$trendvis
dat<-Data
```


We then used a hierarchical modeling structure to understand these residuals as a result of the max observed smoke values in each park in each month.
$$
\begin{aligned}
Resid_{y} &\sim \begin{cases}\operatorname{Norm}(\mu,\sigma)\\ \mu = B_{0Park}+ B_{1Park}*X_{1Park} \\ \sigma\sim Norm(0,1) 
\end{cases}
\end{aligned}
$$

This was also operationalized in `rstanarm`
```{r eval=FALSE, cache=TRUE,include=FALSE}
fit<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=dat,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)

```

### 2.2.2. Model Validation












# 3. Results

## 3.1. Parameter Estimates
For all significant effects (90% C.I. doesn't overlap 0), we see a negative effect of smoke on the residual visitation to National Parks.

```{r echo=FALSE, cache=TRUE, message=FALSE,warning=FALSE}
PNames<-unique(dat$ParkName)

pp<-as.data.frame(posterior_interval(fit))
limits<-row.names(pp[grep("stdsmoke UnitCode",row.names(pp)),])

pars<-plot(fit, regex_pars = "stdsmoke UnitCode",
           prob = 0.5, prob_outer = 0.9)

mytheme<- theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                plot.title = element_text( size=18, color="black",face="bold"),
                axis.title.x = element_text( size=18),
                axis.title.y = element_text( size=18),
                axis.text=(element_text(color="black", size=14)),
                legend.title = element_text(colour="black", size=18),
                legend.text = element_text( size = 14))


```

```{r echo=FALSE, cache=TRUE, message=FALSE,warning=FALSE, fig.height = 9, fig.width = 12}
pars+ggplot2::ggtitle("Posterior medians with 50% and 90% intervals")+
  ggplot2::scale_y_discrete(name ="Park",labels=rev(PNames),limits=rev(limits))+theme_classic()+
  mytheme+scale_x_continuous(name="Parameter Value", labels = scales::comma)+
  theme(panel.grid.major.y = element_line(color = "lightgrey", linetype="dotted")) 
```

## 3.2. Backcasting
We can then go back and apply these estimates effects to the observed visitation given a minimum level of smoke observed for each park to estimate what the visitation may have been given optimal air quality. 

Here's an example from a few parks


```{r include=FALSE, cache=TRUE}


dat<-read.csv("~/SmokeProject/Data/FullDataWithMinSmokePredictions.csv")
dat$date<-zoo::as.yearmon(dat$date)
```

```{r echo=FALSE, warning=FALSE, cache=TRUE,message=FALSE, fig.height = 6, fig.width = 12}
library(scales)
p1<-dat%>%filter(UnitCode == "GLAC")%>%
    ggplot(.,aes(x=date))+
    geom_ribbon(aes(ymin=PredNoSmoke5CI, ymax=PredNoSmoke95CI),fill="#1f78b4",alpha=0.2)+
    geom_ribbon(aes(ymin=PredNoSmoke25CI, ymax=PredNoSmoke75CI),fill="#1f78b4",alpha=0.5)+
    geom_line(aes(y=RecreationVisits,color="darkgrey"),size=1.25)+
    geom_point(aes(y=RecreationVisits,color="black"),size=2)+
    geom_line(aes(y=PredNoSmoke50CI,color="#1f78b4"),linetype="longdash",size=1.25)+theme_classic()+
    mytheme + scale_y_continuous(name="Recreational Visits", labels = scales::comma)+
    scale_x_continuous(name="Date",breaks=c(1980,1990,2000,2010,2018))+
    scale_color_identity(name = "",
                         breaks = c("black", "#1f78b4"),
                         labels = c("Observed", "Median Estimate Minimum Smoke"),
                         guide = "legend")+ggtitle("Glacier National Park")+theme(legend.position="top")+
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.line.x = element_blank())
  
p2<-dat%>%filter(UnitCode == "GLAC")%>%group_by(Year)%>%
    summarise(meansmoke=mean(Smoke))%>%
    ggplot(.,aes(x=Year,y=meansmoke))+
    geom_segment(aes(xend = Year, yend = 2.5e-10,color =(meansmoke)),size=1.5) +
    geom_point(aes(color =(meansmoke)),size=5)+
    scale_color_gradient2(low ="#2b83ba" , mid = "#ffffbf", high = "#d7191c",name= "Difference from trend",breaks=c(0.050,-0.035),
                          labels=c("Above","Below")
    ) + 
    #guides(color = FALSE) +
    guides(alpha = FALSE) + 
    theme_classic()+  scale_x_continuous(name="Date",breaks=c(1980,1990,2000,2010,2018))+
   scale_y_continuous(name="Smoke (PM 2.5)",expand = c(0, 0), limits = c(2.5e-10, 1.25e-9))+mytheme
  

gA <- ggplotGrob(p1)
gB <- ggplotGrob(p2)
grid::grid.newpage()
grid::grid.draw(rbind(gA, gB))
```

```{r echo=FALSE, warning=FALSE, cache=TRUE,message=FALSE, fig.height = 6, fig.width = 12}
library(scales)
p1<-dat%>%filter(UnitCode == "OLYM")%>%
    ggplot(.,aes(x=date))+
    geom_ribbon(aes(ymin=PredNoSmoke5CI, ymax=PredNoSmoke95CI),fill="#1f78b4",alpha=0.2)+
    geom_ribbon(aes(ymin=PredNoSmoke25CI, ymax=PredNoSmoke75CI),fill="#1f78b4",alpha=0.5)+
    geom_line(aes(y=RecreationVisits,color="darkgrey"),size=1.25)+
    geom_point(aes(y=RecreationVisits,color="black"),size=2)+
    geom_line(aes(y=PredNoSmoke50CI,color="#1f78b4"),linetype="longdash",size=1.25)+theme_classic()+
    mytheme + scale_y_continuous(name="Recreational Visits", labels = scales::comma)+
    scale_x_continuous(name="Date",breaks=c(1980,1990,2000,2010,2018))+
    scale_color_identity(name = "",
                         breaks = c("darkgrey", "#1f78b4"),
                         labels = c("Observed", "Median Estimate Minimum Smoke"),
                         guide = "legend")+ggtitle("Olympic National Park")+theme(legend.position="top")+
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.line.x = element_blank())
  
p2<-dat%>%filter(UnitCode == "OLYM")%>%group_by(Year)%>%
    summarise(meansmoke=mean(Smoke))%>%
    ggplot(.,aes(x=Year,y=meansmoke))+
    geom_segment(aes(xend = Year, yend = 1e-10,color =(meansmoke)),size=1.5) +
    geom_point(aes(color =(meansmoke)),size=5)+
    scale_color_gradient2(low ="#2b83ba" , mid = "#ffffbf", high = "#d7191c",name= "Difference from trend",breaks=c(0.050,-0.035),
                          labels=c("Above","Below")
    ) + 
    #guides(color = FALSE) +
    guides(alpha = FALSE) + 
    theme_classic()+  scale_x_continuous(name="Date",breaks=c(1980,1990,2000,2010,2018))+
   scale_y_continuous(name="Smoke (PM 2.5)",expand = c(0, 0), limits = c(1e-10, 9e-10))+mytheme
  

gA <- ggplotGrob(p1)
gB <- ggplotGrob(p2)
grid::grid.newpage()
grid::grid.draw(rbind(gA, gB))
```


```{r echo=FALSE, cache=TRUE}
fitint<-as.data.frame(posterior_interval(fit))
names(fitint)<-c("CI5","CI95")
fitint$Par<-row.names(fitint)
fitsig<-fitint[grep("stdsmoke UnitCode",row.names(fitint)),]%>% 
  filter(CI5<0 & CI95<0) 

fitsig$Par<-substr(fitsig$Par,21,24)

#predicted vis fees 
FEdat<-read.csv("~/SmokeProject/Data/ParkFees.csv")

#get the visitation observed and predicted yearly totals (same scale as fee data)
VEstDat<-dat%>%group_by(UnitCode,Year)%>%
  summarise(RecVisits=sum(RecreationVisits),PredVisits = sum(PredNoSmoke50CI))%>%
  filter(UnitCode %in% fitsig$Par)

#only include significant parks and years we predicted for
FEdat<-FEdat%>%filter(UnitCode%in%fitsig$Par)

#merge the fee and visitation data
financialData<-merge(FEdat, VEstDat, by = c("UnitCode","Year"))

#multiply the fees and visitation (predicted and observed)
financialData<-financialData%>%mutate(incomeObserved= round(SingleVisitorFee*RecVisits,digits = 2),incomePred= round(SingleVisitorFee*PredVisits,digits=2))

#get the dollar estimates for smoke loss for each park)
summaryFinancialLoss<-financialData %>% group_by(UnitCode)%>%summarise(totrec=sum(incomeObserved),totpred=sum(incomePred))%>%
  mutate(IncomeDif=totrec-totpred,IncomePrecDiff=round((1-(totrec/totpred))*100,digits=2))


summaryFinancialLoss$ParkName<-unique(dat[dat$UnitCode %in% summaryFinancialLoss$UnitCode,]$ParkName)

summaryFinancialLoss<-summaryFinancialLoss[,c(6,4,5)]
summaryFinancialLoss$IncomeDif<-currency(summaryFinancialLoss$IncomeDif)
names(summaryFinancialLoss)<-(c("National Park","Income Loss Estimate (1980-2018)", "Percent Income Loss (1980-2018)"))
summaryFinancialLoss$`Percent Income Loss (1980-2018)`<-paste0(summaryFinancialLoss$`Percent Income Loss (1980-2018)`,'%')
```


```{r echo=FALSE, cache=TRUE, warning=FALSE, message=FALSE, fig.height = 8, fig.width = 13}
dat%>%filter(UnitCode %in% fitsig$Par)%>%group_by(ParkName)%>%
  summarise(totrec=sum(RecreationVisits),totpred=sum(PredNoSmoke50CI))%>%ungroup()%>%
  mutate(diff=totpred-totrec)%>%
  ggplot(., 
         aes(y = reorder(ParkName,diff),
             x = totrec,
             xend = totpred)) +  
  ggalt::geom_dumbbell(size = 1.2,
                       size_x = 5, 
                       size_xend = 5,
                       colour = "darkgrey", 
                       colour_x = "black", 
                       colour_xend = "#1f78b4",dot_guide = T,dot_guide_size = NULL,dot_guide_colour = "lightgrey") +
  geom_rect( aes(xmin=91000000, xmax=99000000, ymin=-Inf, ymax=Inf), fill="grey") +
  geom_text( aes(label=paste0("-",round((diff/totrec)*100,digits=1), "%"), y=ParkName, x=95000000), fontface=2, size=4)+
  annotate("text", x = 95000000, y = "Glacier NP", label = "Difference",vjust=-1.5,fontface=2)+
  annotate("text", x = 60000000, y = "Yosemite NP", label = "Observed visitation",vjust=-1,hjust=1,fontface=2)+
  annotate("text", x = 75000000, y = "Yosemite NP", label = "Predicted visitation no smoke",vjust=-1,color="#1f78b4",fontface=2)+
  scale_x_continuous( breaks=seq(10000000,90000000,20000000),labels = scales::comma) + 
  labs(title = "Total Lost Visitation",
       subtitle = "1980 to 2018",
       x = "Total Visits",
       y = "")+theme_classic()+mytheme+theme(plot.subtitle = element_text(face = "bold"))


```

We can apply these visitation estimates to the fee data/predictions also.
```{r echo=FALSE, cache=TRUE, warning=FALSE, message=FALSE, fig.height = 8, fig.width = 13}
financialData%>%filter(UnitCode %in% fitsig$Par)%>%group_by(Park)%>%
  summarise(sumincome=sum(incomeObserved),sumincomePred=sum(incomePred))%>%ungroup()%>%
  mutate(diff=sumincomePred-sumincome)%>%
  ggplot(., 
         aes(y = reorder(Park,diff),
             x = sumincome,
             xend = sumincomePred)) +  
  ggalt::geom_dumbbell(size = 1.2,
                       size_x = 5, 
                       size_xend = 5,
                       colour = "darkgrey", 
                       colour_x = "black", 
                       colour_xend = "#41ab5d",dot_guide = T,dot_guide_size = NULL,dot_guide_colour = "lightgrey")+
  geom_rect( aes(xmin=860000000, xmax=940000000, ymin=-Inf, ymax=Inf), fill="grey") +
  geom_text( aes(label=paste0("-",round((diff/sumincome)*100,digits=1), "%"), y=Park, x=900000000), fontface=2, size=4)+
  annotate("text", x = 900000000, y = "Glacier NP", label = "Difference",vjust=-1.5,fontface=2)+
  scale_x_continuous( labels = scales::dollar_format(prefix = "$")) +
  annotate("text", x = 453357090, y = "Yosemite NP", label = "Observed fee revenue",vjust=-1,fontface=2)+
  annotate("text", x = 682294835, y = "Yosemite NP", label = "Predicted fee revenue no smoke",vjust=-1,color="#41ab5d",fontface=2)+
  labs(title = "Total Lost Revenue",
       subtitle = "1980 to 2018",
       x = "Total Visitor Revenue 1980 to 2018",
       y = "")+theme_classic()+mytheme+theme(plot.subtitle = element_text(face = "bold"))
```






# 4. Discussion

Discussion here



# S. Supplemental

## S.1. Visitation Fee Back Predicting Accuracy
We then used this to predict what the fees would have been for every year we didn't have
```{r cache=TRUE, include=FALSE}

FEdat<-read.csv("~/SmokeProject/Data/LauraStoddardEntryFeeCsv.csv")
FEdat<-FEdat %>% dplyr::select(Park,Year,SingleVisitorEntryFee) #keep only these columns

d<-na.omit(FEdat) #get rid of rows with any NA


fillData<-FEdat[,1:2]


FEdat$PredictedFee<-apply(posterior_predict(feefit,fillData),2,mean) #assuming this is for a new column

```

Our predicted fees correlate well with our observed fees that we have
```{r echo = FALSE, cache=TRUE,message=FALSE,warning=FALSE}
xx<-na.omit(FEdat)
 mytheme<- theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                  plot.title = element_text( size=18, color="black",face="bold"),
                  axis.title.x = element_text( size=18),
                  axis.title.y = element_text( size=18),
                  axis.text=(element_text(color="black", size=14)),
                  legend.title = element_text(colour="black", size=18),
                  legend.text = element_text( size = 14))
xx%>%
  ggplot(.,aes(x=SingleVisitorEntryFee,y=PredictedFee))+
  geom_jitter(size=2, alpha=0.3)+
  geom_smooth(method="lm", se=FALSE, colour="black",size=2,linetype="longdash")+
  geom_text(aes(x=5,y=15),size=10,label=paste("cor =",round(cor(xx$PredictedFee,xx$SingleVisitorEntryFee),digits=2)))+
  ggtitle("Predicted vs Observed Single Visitor Entry Fee")+theme_classic()+mytheme+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_y_continuous(name="Predicted Single Visitor Entry Fee",labels = scales::dollar_format(prefix = "$"))+
  scale_x_continuous(name="Observed Single Visitor Entry Fee",labels = scales::dollar_format(prefix = "$"))
```


## S.2. Model Validation Process

```{r echo=FALSE, message=FALSE,cache=TRUE}
knitr::include_graphics(path.expand("~/SmokeProject/Train_Test.png"))
```

## S.3. Model Validation Results
To assess the validity of our model, we used a k-fold cross validation technique.   


```{r echo=FALSE, message=FALSE,cache=TRUE}
library(tidyverse)
library(rstanarm)
#pull out last 5 years
train1<-dat%>%filter(!Year %in% c("2018","2017","2016","2015","2014"))
test1<-dat%>%filter(Year %in% c("2018","2017","2016","2015","2014"))




#fitTrain<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=train1,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)
#save(fitTrain,file="CVResidualMod.rds")
load("~/SmokeProject/ModelObjects/CVResidualMod.rds")

preds1<-apply(posterior_predict(fitTrain,test1),2,median)
reals1<-test1$VisDiff


## 2013:2009

train2<-dat%>%filter(!Year %in% c("2013","2012","2011","2010","2009"))
test2<-dat%>%filter(Year %in% c("2013","2012","2011","2010","2009"))
#fitTrain2<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=train2,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)
#save(fitTrain2,file="CVResidualMod2.rds")
load("~/SmokeProject/ModelObjects/CVResidualMod2.rds")

preds2<-apply(posterior_predict(fitTrain2,test2),2,median)
reals2<-test2$VisDiff

# 2008:2004
train3<-dat%>%filter(!Year %in% c("2008","2007","2006","2005","2004"))
test3<-dat%>%filter(Year %in% c("2008","2007","2006","2005","2004"))
#fitTrain3<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=train3,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)
#save(fitTrain3,file="CVResidualMod3.rds")
load("~/SmokeProject/ModelObjects/CVResidualMod3.rds")

preds3<-apply(posterior_predict(fitTrain3,test3),2,median)
reals3<-test3$VisDiff

# 2003:1999
train4<-dat%>%filter(!Year %in% c("2003","2002","2001","2000","1999"))
test4<-dat%>%filter(Year %in% c("2003","2002","2001","2000","1999"))
#fitTrain4<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=train4,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)
#save(fitTrain4,file="CVResidualMod4.rds")
load("~/SmokeProject/ModelObjects/CVResidualMod4.rds")

preds4<-apply(posterior_predict(fitTrain4,test4),2,median)
reals4<-test4$VisDiff

# 1998:1994
train5<-dat%>%filter(!Year %in% c("1998","1997","1996","1995","1994"))
test5<-dat%>%filter(Year %in% c("1998","1997","1996","1995","1994"))
#fitTrain5<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=train5,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)
#save(fitTrain5,file="CVResidualMod5.rds")
load("~/SmokeProject/ModelObjects/CVResidualMod5.rds")

preds5<-apply(posterior_predict(fitTrain5,test5),2,median)
reals5<-test5$VisDiff

# 1993:1989
train6<-dat%>%filter(!Year %in% c("1993","1992","1991","1990","1989"))
test6<-dat%>%filter(Year %in% c("1993","1992","1991","1990","1989"))
#fitTrain6<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=train6,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)
#save(fitTrain6,file="CVResidualMod6.rds")
load("~/SmokeProject/ModelObjects/CVResidualMod6.rds")

preds6<-apply(posterior_predict(fitTrain6,test6),2,median)
reals6<-test6$VisDiff

# 1988:1980
train7<-dat%>%filter(!Year %in% c("1988","1987","1986","1985","1984","1983","1982","1981","1980"))
test7<-dat%>%filter(Year %in% c("1988","1987","1986","1985","1984","1983","1982","1981","1980"))
#fitTrain7<-stan_lmer(VisDiff~stdsmoke|UnitCode,data=train7,adapt_delta = 0.99,chains=8,warmup=2000,iter=8000)
#save(fitTrain7,file="CVResidualMod7.rds")
load("~/SmokeProject/ModelObjects/CVResidualMod7.rds")

preds7<-apply(posterior_predict(fitTrain7,test7),2,median)
reals7<-test7$VisDiff

#combine them all
preds<-c(preds1,preds2,preds3,preds4,preds5,preds6,preds7)
reals<-c(reals1,reals2,reals3,reals4,reals5,reals6,reals7)

d<-as.data.frame(cbind(as.vector(preds),reals))
names(d)<-c("preds","reals")
mytheme<- theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                plot.title = element_text( size=18, color="black",face="bold"),
                axis.title.x = element_text( size=18),
                axis.title.y = element_text( size=18),
                axis.text=(element_text(color="black", size=14)),
                legend.title = element_text(colour="black", size=18),
                legend.text = element_text( size = 14))
d%>%
  ggplot(.,aes(x=reals,y=preds))+
  geom_point(size=2.5, alpha=0.2)+
  geom_smooth(method="lm", se=FALSE, colour="black",size=2,linetype="longdash")+
  geom_text(aes(x=3e+05,y=-2e+05),size=10,label=paste("cor =",round(cor(d$preds,d$reals),digits=2)))+
  ggtitle("CV Results")+theme_classic()+mytheme+scale_x_continuous("Observed Residual Visitation", labels = scales::comma)+
  scale_y_continuous(name="Predicted Residual Visitation", labels = scales::comma)+
  theme(plot.title = element_text(hjust = 0.5))

```

```{r echo=FALSE, message=FALSE,cache=TRUE}
x<-data.frame(Model=c(1:7), 
              "TimePeriod"=c("1980 - 1988",
                                         "1989 - 1993",
                                         "1994 - 1998",
                                         "1999 - 2003",
                           "2004 - 2008",
                           "2009 - 2013",
                           "2014 - 2018"), 
              Correlation=c(cor(as.vector(preds1),reals1),
                                                   cor(as.vector(preds2),reals2),
                                                   cor(as.vector(preds3),reals3),
                                                   cor(as.vector(preds4),reals4),
                                                   cor(as.vector(preds5),reals5),
                                                   cor(as.vector(preds6),reals6),
                                                   cor(as.vector(preds7),reals7)))

x$r2<-round(x$Correlation^2,digits=2)
x$Correlation<-round(x$Correlation,digits=2)
names(x)<-c("Model","Time Period", "Correlation", "R^2")
formattable::formattable(x)
```






