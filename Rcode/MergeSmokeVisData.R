library(tidyverse)
SmokeDat<-read_csv("~/Smoke_Proj/interm_data/final_max.csv")
View(SmokeDat)
VisDat<-read_csv("~/Smoke_Proj/Data/VisitationDataClean.csv")
View(VisDat)

library(tidyr)

#Make a "long" version of the smoke data
sml<-gather(SmokeDat, Date, Smoke, X198001:X201910, factor_key = F)
View(sml)

#Change the format of the dates to match the vis data
sml$Year<-substr(sml$Date, 2,5)
sml$Month<-substr(sml$Date, 6,7)

#create a Jan-Sept vector
x<-1:9
#Make it a character so it's a btit easier
VisDat$Month<-as.character(VisDat$Month)
#add a 0 to the front of the single diget months to match the smoke data
VisDat$Month<-ifelse(VisDat$Month %in% x,
       paste0("0", VisDat$Month),paste0("", VisDat$Month)) 
VisDat$Year<-as.character(VisDat$Year)

#Match the names of the parks
names(sml)[1]<-"UnitCode"

#merge the datasets by park, and month
mdat<-merge(x=VisDat,y=sml,by=c("UnitCode", "Year","Month"))
#remove columns we dont need            
mdat<-mdat[,-c(4,7)]

#Create a standardized smoke variable

##standardization function doing some weird rounding thing
## Doing it in 2 steps doesn't yeild the same problem
#zz<-mdat$Smoke-mean(mdat$Smoke)
#mdat$stdsmoke<-zz/(2*sd(mdat$Smoke))
mdat$stdsmoke<-as.vector(scale(mdat$Smoke))


#make month categorical
mdat$Month<-as.character(mdat$Month)
#Create a season variable
mdat$Season<-ifelse(mdat$Month %in% c("03","04","05"),"Spring",
                   ifelse(mdat$Month %in% c("06","07","08"),"Summer",
                          ifelse(mdat$Month %in% c("09","10","11"),"Fall","Winter")))

#make combined variables for park/season and park/month
mdat$CatColS<-paste0(mdat$UnitCode,mdat$Season)

mdat$CatColM<-paste0(mdat$UnitCode,mdat$Month)

#create a variable for stdized smoke by park
#sdd1<-function(x) {return(x-mean(x))}
#sdd2<-function(x) {return(x/(2*sd(x)))}

#mdat<-mdat%>%group_by(UnitCode)%>%
  #mutate(deletelater=sdd1(Smoke))%>%
  #mutate(stdsmokepark=sdd2(deletelater))

#delete int vector
#mdat<-mdat[,-11]

#add vis season
x<-mdat%>%group_by(UnitCode,Season)%>%
  summarise(mv=mean(RecreationVisits))%>%ungroup()%>%
  group_by(UnitCode)%>%filter(mv==max(mv))%>%mutate(cc=paste0(UnitCode,Season))

x2<-mdat%>%group_by(UnitCode,Season)%>%
  summarise(mv=mean(RecreationVisits))%>%ungroup()%>%
  group_by(UnitCode)%>%filter(mv==min(mv))%>%mutate(cc=paste0(UnitCode,Season))

mdat$SeasType<-ifelse(mdat$CatColS %in% x$cc,
                     "High",ifelse(mdat$CatColS %in% x2$cc,"Low","Shoulder"))

#regions_states
rd<-read.csv("~/SmokeProject/Data/States_Regions.csv")[-c(44,57),-1]

mdat<-merge(mdat,rd,by="UnitCode")

#create the csv
write.csv(mdat, file="MergedDataComplete.csv")
